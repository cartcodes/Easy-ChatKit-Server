<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatKit Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #e8e8e8;
      color: #2a2a2a;
      line-height: 1.5;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    .top-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 20px;
      background: #f5f5f5;
      border-bottom: 1px solid #d0d0d0;
    }
    .card {
      background: #f5f5f5;
      border: 1px solid #d0d0d0;
      min-width: 0;
      overflow: hidden;
      margin-bottom: 20px;
    }
    @media (max-width: 1024px) {
      .top-cards {
        grid-template-columns: 1fr;
      }
    }
    .demo-section {
      padding: 20px;
      background: #f5f5f5;
      border-bottom: 1px solid #d0d0d0;
      position: relative;
      box-sizing: border-box;
    }
    .demo-section h2 {
      font-size: 14px;
      font-weight: 600;
      color: #4a4a4a;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      z-index: 1;
    }
    .code-section {
      display: flex;
      flex-direction: column;
    }
    .code-block {
      background: #f5f5f5;
    }
    .code-block h3 {
      padding: 12px 20px;
      background: #e8e8e8;
      color: #2a2a2a;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 600;
      border-bottom: 1px solid #d0d0d0;
    }
    .code-block h3:hover {
      background: #ddd;
    }
    .code-content {
      max-height: 2000px;
      overflow: hidden;
    }
    .code-inner {
      padding: 20px;
      min-width: 0;
      max-width: 100%;
    }
    .customization-panel {
      background: #f8f8f8;
      padding: 12px;
      border: 1px solid #d0d0d0;
      margin-bottom: 12px;
      max-width: 100%;
    }
    .customization-panel h4 {
      margin-bottom: 10px;
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .control-group {
      margin-bottom: 12px;
      max-width: 100%;
    }
    .control-group label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #4a4a4a;
      word-wrap: break-word;
    }
    .control-group input[type="text"] {
      width: 100%;
      max-width: 100%;
      padding: 6px 8px;
      border: 1px solid #c0c0c0;
      font-size: 13px;
      box-sizing: border-box;
      background: #fff;
    }
    .control-group input[type="color"] {
      width: 50px;
      height: 50px;
      padding: 0;
      border: none;
      cursor: pointer;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background: transparent;
    }
    .control-group input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
    }
    .control-group input[type="color"]::-webkit-color-swatch {
      border: none;
      border-radius: 0;
    }
    .control-group input[type="color"]::-moz-color-swatch {
      border: none;
      border-radius: 0;
    }
    .emoji-picker-container {
      position: relative;
      width: 48px;
      max-width: 100%;
    }
    .emoji-display {
      width: 48px;
      height: 48px;
      padding: 8px;
      border: 1px solid #c0c0c0;
      background: white;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
    }
    .emoji-display svg {
      width: 24px;
      height: 24px;
    }
    .emoji-display:hover {
      background: #f8f8f8;
      border-color: #a0a0a0;
    }
    .emoji-grid {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      width: 120px;
      background: white;
      border: 1px solid #c0c0c0;
      padding: 6px;
      margin-top: 2px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 1000;
      max-height: 180px;
      overflow-y: auto;
      grid-template-columns: repeat(3, 1fr);
      gap: 3px;
    }
    .emoji-grid.show {
      display: grid;
    }
    .emoji-option {
      width: 32px;
      height: 32px;
      padding: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.15s;
      background: transparent;
    }
    .emoji-option svg {
      width: 18px;
      height: 18px;
    }
    .emoji-option:hover {
      background: #e8e8e8;
    }
    .emoji-option.active {
      background: #d0d0d0;
      border: 1px solid #a0a0a0;
    }
    .control-group input[type="checkbox"] {
      margin-right: 6px;
      cursor: pointer;
    }
    .control-group input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #e8e8e8;
      outline: none;
      cursor: pointer;
      -webkit-appearance: none;
    }
    .control-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #4a4a4a;
      cursor: pointer;
    }
    .control-group input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #4a4a4a;
      cursor: pointer;
      border: none;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-weight: normal;
      font-size: 12px;
    }
    .instructions {
      background: #f8f8f8;
      border: 1px solid #d0d0d0;
      padding: 10px;
      margin-bottom: 12px;
      font-size: 12px;
      line-height: 1.4;
      color: #4a4a4a;
      max-width: 100%;
      word-wrap: break-word;
    }
    .instructions strong {
      color: #2a2a2a;
    }
    pre {
      background: #f8f8f8;
      padding: 12px;
      overflow-x: auto;
      font-size: 11px;
      line-height: 1.4;
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid #d0d0d0;
      font-family: 'Courier New', monospace;
      max-width: 100%;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .copy-button {
      background: #4a4a4a;
      color: white;
      padding: 8px 16px;
      border: 1px solid #2a2a2a;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      margin-top: 8px;
      transition: all 0.15s;
    }
    .copy-button:hover {
      background: #2a2a2a;
    }
    .copy-button.copied {
      background: #5a5a5a;
    }
    code {
      background: #e8e8e8;
      padding: 2px 4px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
    }
    .badge {
      display: inline-block;
      padding: 3px 6px;
      background: #6a6a6a;
      color: white;
      font-size: 10px;
      font-weight: 500;
      margin-left: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .corner-indicator {
      position: fixed;
      bottom: 100px;
      right: 100px;
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f5f5f5;
      padding: 8px 12px;
      border: 1px solid #c0c0c0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 999997;
      font-size: 12px;
      font-weight: 500;
      color: #4a4a4a;
      pointer-events: none;
    }
    .corner-indicator::after {
      content: '↘';
      font-size: 20px;
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <!-- Corner widget indicator -->
  <div class="corner-indicator">Preview of Corner Widget</div>

  <div class="container">
    <!-- Top cards section -->
    <div class="top-cards">
      <div class="card">
        <div class="code-block">
          <h3>
            <span>Corner Widget</span>
          </h3>
          <div class="code-content">
            <div class="code-inner">
            <div class="instructions">
            <strong>How to use:</strong> Customize your corner button below, then copy the code and paste it anywhere in your HTML (preferably before <code>&lt;/body&gt;</code>). The chat button will appear in the bottom-right corner of your page.
          </div>

          <div class="customization-panel">
            <h4>Customize Corner Button</h4>

            <div class="control-group">
              <label>Icon:</label>
              <div class="emoji-picker-container">
                <div class="emoji-display" id="emoji-display" onclick="toggleEmojiPicker(event)"></div>
                <div class="emoji-grid" id="emoji-grid"></div>
              </div>
              <input type="hidden" id="emoji-closed" value="message-circle">
            </div>

            <div class="control-group">
              <label>Background Color:</label>
              <input type="color" id="button-color" value="#0700eb" oninput="updateCornerCode()">
            </div>

            <div class="control-group">
              <label>Icon Color:</label>
              <input type="color" id="icon-color" value="#ffffff" oninput="updateCornerCode()">
            </div>

            <div class="control-group">
              <label>Border Radius: <span id="radius-value">0</span>%</label>
              <input type="range" id="border-radius" min="0" max="50" value="0" step="1" oninput="updateCornerCode()" style="width: 100%;">
            </div>

          </div>

              <pre id="corner-code"></pre>
              <button class="copy-button" onclick="copyCode('corner')">Copy Code</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="code-block">
          <h3>
            <span>Embedded Widget</span>
          </h3>
          <div class="code-content">
            <div class="code-inner">
              <div class="instructions">
                <strong>How to use:</strong> Copy the code below and paste it into your HTML where you want the chat widget to appear. Make sure to include the container <code>&lt;div&gt;</code> and both script tags.
              </div>

              <div class="customization-panel">
                <h4>Customize Embed</h4>

                <div class="control-group">
                  <label class="checkbox-label">
                    <input type="checkbox" id="embed-fullscreen" onchange="updateEmbedCode()">
                    Full Screen
                  </label>
                </div>

                <div class="control-group" id="embed-width-group">
                  <label>Width: <span id="embed-width-value">600</span>px</label>
                  <input type="range" id="embed-width" min="300" max="1200" value="600" step="10" oninput="updateEmbedCode()" style="width: 100%;">
                </div>

                <div class="control-group" id="embed-height-group">
                  <label>Height: <span id="embed-height-value">450</span>px</label>
                  <input type="range" id="embed-height" min="300" max="800" value="450" step="10" oninput="updateEmbedCode()" style="width: 100%;">
                </div>
              </div>

              <pre id="embed-code"></pre>
              <button class="copy-button" onclick="copyCode('embed')">Copy Code</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="demo-section">
      <h2>Preview of Embedded Widget</h2>
      <div id="chatkit-embed" style="width: 100%; max-width: 600px; height: 450px; box-sizing: border-box;"></div>
    </div>
  </div>

  <script>
    // Get current server URL dynamically
    let SERVER_URL = window.location.origin;

    // Fetch base URL from server
    async function fetchBaseUrl() {
      try {
        const response = await fetch('/api/base-url');
        const data = await response.json();
        SERVER_URL = data.baseUrl;
      } catch (error) {
        console.error('Failed to fetch base URL, using origin:', error);
      }
    }

    // SVG Icon helper - returns SVG string for icon
    function getIconSVG(iconName, strokeWidth = 2) {
      const icons = {
        'message-circle': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>`,
        'message-square': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>`,
        'mail': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path></svg>`,
        'send': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"></path><path d="M22 2 11 13"></path></svg>`,
        'help-circle': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`,
        'info': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`,
        'sparkles': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>`,
        'zap': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`,
        'star': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`,
        'heart': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`,
        'smile': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>`,
        'user': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`,
        'users': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
        'phone': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>`,
        'video': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>`,
        'headphones': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><path d="M3 18v-6a9 9 0 0 1 18 0v6"></path><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"></path></svg>`,
        'bell': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>`,
        'settings': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v6m0 6v6m5.66-15.66l-4.24 4.24m-2.83 2.83-4.24 4.24m15.31.01-4.24-4.24m-2.83-2.83-4.24-4.24"></path></svg>`,
        'search': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>`,
        'plus': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
        'check': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
        'arrow-right': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>`,
        'x': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`
      };
      return icons[iconName] || icons['message-circle'];
    }

    // Popular icons for the picker
    const icons = ['message-circle', 'message-square', 'mail', 'send', 'help-circle', 'info', 'sparkles', 'zap', 'star', 'heart', 'smile', 'user', 'users', 'phone', 'video', 'headphones', 'bell', 'settings', 'search', 'plus', 'check', 'arrow-right'];

    // Initialize icon picker
    function initEmojiPicker() {
      const grid = document.getElementById('emoji-grid');
      icons.forEach(iconName => {
        const option = document.createElement('div');
        option.className = 'emoji-option';
        option.setAttribute('data-icon', iconName);
        option.innerHTML = getIconSVG(iconName, 2);
        option.onclick = (e) => {
          e.stopPropagation();
          selectEmoji(iconName);
        };
        grid.appendChild(option);
      });
      updateActiveEmoji();
    }

    // Toggle emoji picker
    function toggleEmojiPicker(e) {
      e.stopPropagation();
      const grid = document.getElementById('emoji-grid');
      const isShowing = grid.classList.contains('show');
      grid.classList.toggle('show');

      if (!isShowing) {
        updateActiveEmoji();
      }
    }

    // Update active icon highlight
    function updateActiveEmoji() {
      const currentIcon = document.getElementById('emoji-closed').value;
      const options = document.querySelectorAll('.emoji-option');
      options.forEach(option => {
        if (option.getAttribute('data-icon') === currentIcon) {
          option.classList.add('active');
        } else {
          option.classList.remove('active');
        }
      });
    }

    // Select icon
    function selectEmoji(iconName) {
      document.getElementById('emoji-closed').value = iconName;
      const display = document.getElementById('emoji-display');
      display.innerHTML = getIconSVG(iconName, 2);
      document.getElementById('emoji-grid').classList.remove('show');
      updateActiveEmoji();
      updateCornerCode();
      updateLiveDemo();
    }

    // Close emoji picker when clicking outside
    document.addEventListener('click', (e) => {
      const picker = document.querySelector('.emoji-picker-container');
      const grid = document.getElementById('emoji-grid');
      if (picker && !picker.contains(e.target) && grid) {
        grid.classList.remove('show');
      }
    });

    // Generate corner mode code with customization
    function generateCornerCode() {
      const iconClosed = document.getElementById('emoji-closed')?.value || 'message-circle';
      const iconActive = 'x'; // Fixed active icon (X icon)
      const buttonColor = document.getElementById('button-color')?.value || '#0700eb';
      const iconColor = document.getElementById('icon-color')?.value || '#ffffff';
      const borderRadius = document.getElementById('border-radius')?.value || '0';

      // Update radius value display
      const radiusValueEl = document.getElementById('radius-value');
      if (radiusValueEl) radiusValueEl.textContent = borderRadius;

      const iconClosedSVG = getIconSVG(iconClosed, 2).replace(/"/g, "'").replace(/currentColor/g, iconColor);
      const iconActiveSVG = getIconSVG(iconActive, 2).replace(/"/g, "'").replace(/currentColor/g, iconColor);

      return `<!-- Load ChatKit CDN -->
<script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js"><\/script>

<!-- Initialize corner widget -->
<script>
(function() {
  const CHATKIT_SERVER_URL = '${SERVER_URL}'; // UPDATE THIS IF DEPLOYING

  customElements.whenDefined('openai-chatkit').then(async () => {
    // Get or create user ID
    let userId = localStorage.getItem('chatkit_user_id');
    if (!userId) {
      userId = \`user_\${Date.now()}_\${Math.random().toString(36).substring(7)}\`;
      localStorage.setItem('chatkit_user_id', userId);
    }

    // Get client secret
    async function getClientSecret() {
      const response = await fetch(\`\${CHATKIT_SERVER_URL}/api/chatkit/session\`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId })
      });
      const data = await response.json();
      return data.client_secret;
    }

    // Fetch config
    const configResponse = await fetch(\`\${CHATKIT_SERVER_URL}/api/chatkit/config\`);
    const config = await configResponse.json();

    // Create corner widget
    const style = document.createElement('style');
    style.textContent = \`
      .chatkit-corner-button {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 60px;
        height: 60px;
        border-radius: ${borderRadius}%;
        background: ${buttonColor};
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        transition: all 0.3s ease;
        z-index: 999999;
      }
      .chatkit-corner-button svg {
        width: 28px;
        height: 28px;
        stroke: ${iconColor};
      }
      .chatkit-corner-button:hover {
        transform: scale(1.1);
      }
      .chatkit-corner-window {
        position: fixed;
        bottom: 100px;
        right: 24px;
        width: 400px;
        height: 600px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        display: none;
        z-index: 999998;
      }
      .chatkit-corner-window.open {
        display: block;
      }
      .chatkit-corner-window openai-chatkit {
        width: 100%;
        height: 100%;
      }
    \`;
    document.head.appendChild(style);

    const button = document.createElement('button');
    button.className = 'chatkit-corner-button';
    button.innerHTML = \`${iconClosedSVG}\`;
    document.body.appendChild(button);

    const window = document.createElement('div');
    window.className = 'chatkit-corner-window';
    const chatkit = document.createElement('openai-chatkit');
    window.appendChild(chatkit);
    document.body.appendChild(window);

    let isInitialized = false;
    button.addEventListener('click', () => {
      const isOpen = window.classList.toggle('open');
      button.innerHTML = isOpen ? \`${iconActiveSVG}\` : \`${iconClosedSVG}\`;

      if (isOpen && !isInitialized) {
        chatkit.setOptions({
          ...config,
          api: { getClientSecret }
        });
        isInitialized = true;
      }
    });
  });
})();
<\/script>`;
    }

    // Update corner code when customization changes
    function updateCornerCode() {
      const cornerCode = generateCornerCode();
      document.getElementById('corner-code').textContent = cornerCode;
    }

    // Update embed code when customization changes
    function updateEmbedCode() {
      const embedCode = generateEmbedCode();
      document.getElementById('embed-code').textContent = embedCode;

      const isFullScreen = document.getElementById('embed-fullscreen')?.checked || false;
      const embedWidth = document.getElementById('embed-width')?.value || '600';
      const embedHeight = document.getElementById('embed-height')?.value || '450';
      const widthGroup = document.getElementById('embed-width-group');
      const heightGroup = document.getElementById('embed-height-group');
      const liveEmbed = document.getElementById('chatkit-embed');
      const demoSection = liveEmbed?.parentElement;

      // Hide/show width and height sliders based on full screen mode
      if (widthGroup) {
        widthGroup.style.display = isFullScreen ? 'none' : 'block';
      }
      if (heightGroup) {
        heightGroup.style.display = isFullScreen ? 'none' : 'block';
      }

      // Update demo section height dynamically
      if (demoSection) {
        if (isFullScreen) {
          demoSection.style.height = '650px';
        } else {
          // Height + padding top/bottom (20px each) + h2 heading (~30px)
          const totalHeight = parseInt(embedHeight) + 40 + 30;
          demoSection.style.height = totalHeight + 'px';
        }
      }

      // Update live embed preview
      if (liveEmbed) {
        if (isFullScreen) {
          liveEmbed.style.width = '';
          liveEmbed.style.height = '';
          liveEmbed.style.maxWidth = '';
          liveEmbed.style.position = 'absolute';
          liveEmbed.style.top = '50px';
          liveEmbed.style.left = '20px';
          liveEmbed.style.right = '20px';
          liveEmbed.style.bottom = '20px';
          liveEmbed.style.boxSizing = '';
        } else {
          liveEmbed.style.width = '100%';
          liveEmbed.style.maxWidth = embedWidth + 'px';
          liveEmbed.style.height = embedHeight + 'px';
          liveEmbed.style.position = 'static';
          liveEmbed.style.top = '';
          liveEmbed.style.left = '';
          liveEmbed.style.right = '';
          liveEmbed.style.bottom = '';
          liveEmbed.style.boxSizing = 'border-box';
        }
      }
    }

    // Update the live demo button on the page
    function updateLiveDemo() {
      const liveButton = document.querySelector('.chatkit-corner-button');
      if (liveButton) {
        const iconClosed = document.getElementById('emoji-closed')?.value || 'message-circle';
        const buttonColor = document.getElementById('button-color')?.value || '#0700eb';
        const iconColor = document.getElementById('icon-color')?.value || '#ffffff';
        const borderRadius = document.getElementById('border-radius')?.value || '0';

        // Update icon with proper color
        const chatWindow = document.querySelector('.chatkit-corner-window');
        const isOpen = chatWindow && chatWindow.classList.contains('open');
        const currentIcon = isOpen ? 'x' : iconClosed;
        const iconSVG = getIconSVG(currentIcon, 2).replace(/currentColor/g, iconColor);
        liveButton.innerHTML = iconSVG;

        // Force update the SVG stroke color
        const svg = liveButton.querySelector('svg');
        if (svg) {
          svg.style.stroke = iconColor;
        }

        liveButton.style.background = buttonColor;
        liveButton.style.borderRadius = borderRadius + '%';
      }
    }

    // Embed mode code generator
    function generateEmbedCode() {
      const isFullScreen = document.getElementById('embed-fullscreen')?.checked || false;
      const embedWidth = document.getElementById('embed-width')?.value || '600';
      const embedHeight = document.getElementById('embed-height')?.value || '450';

      // Update width and height value displays
      const widthValueEl = document.getElementById('embed-width-value');
      const heightValueEl = document.getElementById('embed-height-value');
      if (widthValueEl) widthValueEl.textContent = embedWidth;
      if (heightValueEl) heightValueEl.textContent = embedHeight;

      const containerStyle = isFullScreen
        ? 'position: absolute; top: 0; left: 0; width: 100%; height: 100%;'
        : `width: 100%; max-width: ${embedWidth}px; height: ${embedHeight}px; box-sizing: border-box;`;

      const containerComment = isFullScreen
        ? '<!-- Add container where you want the chat (parent element should have position: relative and defined height) -->'
        : '<!-- Add container where you want the chat (responsive to screen size) -->';

      return `${containerComment}
<div id="chatkit-embed" style="${containerStyle}"></div>

<!-- Load ChatKit CDN -->
<script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js"><\/script>

<!-- Initialize embed widget -->
<script>
(function() {
  const CHATKIT_SERVER_URL = '${SERVER_URL}'; // UPDATE THIS IF DEPLOYING

  customElements.whenDefined('openai-chatkit').then(async () => {
    // Get or create user ID
    let userId = localStorage.getItem('chatkit_user_id');
    if (!userId) {
      userId = \`user_\${Date.now()}_\${Math.random().toString(36).substring(7)}\`;
      localStorage.setItem('chatkit_user_id', userId);
    }

    // Get client secret
    async function getClientSecret() {
      const response = await fetch(\`\${CHATKIT_SERVER_URL}/api/chatkit/session\`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId })
      });
      const data = await response.json();
      return data.client_secret;
    }

    // Fetch config
    const configResponse = await fetch(\`\${CHATKIT_SERVER_URL}/api/chatkit/config\`);
    const config = await configResponse.json();

    // Create embed widget
    const container = document.getElementById('chatkit-embed');
    const chatkit = document.createElement('openai-chatkit');
    container.appendChild(chatkit);

    chatkit.setOptions({
      ...config,
      api: { getClientSecret }
    });
  });
})();
<\/script>`;
    }

    // Initialize on page load
    async function initPage() {
      await fetchBaseUrl();
      initEmojiPicker();
      const display = document.getElementById('emoji-display');
      const defaultIcon = document.getElementById('emoji-closed').value;
      display.innerHTML = getIconSVG(defaultIcon, 2);
      updateEmbedCode();
      updateCornerCode();
    }
    initPage();

    // Update live demo when customization changes
    document.getElementById('button-color').addEventListener('input', updateLiveDemo);
    document.getElementById('icon-color').addEventListener('input', updateLiveDemo);
    document.getElementById('border-radius').addEventListener('input', updateLiveDemo);

    // Copy function
    function copyCode(mode) {
      const code = mode === 'corner' ? generateCornerCode() : generateEmbedCode();
      const button = event.target;

      navigator.clipboard.writeText(code).then(() => {
        const originalText = button.textContent;
        button.textContent = '✓ Copied!';
        button.classList.add('copied');

        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove('copied');
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy. Please copy manually from the code block.');
      });
    }
  </script>

  <!-- Load ChatKit CDN -->
  <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js"></script>

  <!-- Corner Widget -->
  <script>
  (function() {
    // Fetch base URL from server
    let CHATKIT_SERVER_URL = window.location.origin;

    async function initCornerWidget() {
      try {
        const urlResponse = await fetch('/api/base-url');
        const urlData = await urlResponse.json();
        CHATKIT_SERVER_URL = urlData.baseUrl;
      } catch (error) {
        console.error('Failed to fetch base URL:', error);
      }

      // Get or create user ID
      let userId = localStorage.getItem('chatkit_user_id');
      if (!userId) {
        userId = `user_${Date.now()}_${Math.random().toString(36).substring(7)}`;
        localStorage.setItem('chatkit_user_id', userId);
      }

      // Get client secret
      async function getClientSecret() {
        const response = await fetch(`${CHATKIT_SERVER_URL}/api/chatkit/session`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId })
        });
        const data = await response.json();
        return data.client_secret;
      }

      // Fetch config
      const configResponse = await fetch(`${CHATKIT_SERVER_URL}/api/chatkit/config`);
      const config = await configResponse.json();

      // Create corner widget
      const style = document.createElement('style');
      style.textContent = `
        .chatkit-corner-button {
          position: fixed;
          bottom: 24px;
          right: 24px;
          width: 60px;
          height: 60px;
          border-radius: 0%;
          background: #0700eb;
          color: white;
          border: none;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 24px;
          transition: all 0.3s ease;
          z-index: 999999;
        }
        .chatkit-corner-button svg {
          width: 28px;
          height: 28px;
          stroke: white;
        }
        .chatkit-corner-button:hover {
          transform: scale(1.1);
        }
        .chatkit-corner-window {
          position: fixed;
          bottom: 100px;
          right: 24px;
          width: 400px;
          height: 600px;
          background: white;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.2);
          display: none;
          z-index: 999998;
        }
        .chatkit-corner-window.open {
          display: block;
        }
        .chatkit-corner-window openai-chatkit {
          width: 100%;
          height: 100%;
        }
      `;
      document.head.appendChild(style);

      const button = document.createElement('button');
      button.className = 'chatkit-corner-button';
      button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>';

      // Apply initial icon color
      const initialSvg = button.querySelector('svg');
      if (initialSvg) {
        const iconColor = document.getElementById('icon-color')?.value || '#ffffff';
        initialSvg.style.stroke = iconColor;
      }

      document.body.appendChild(button);

      const window = document.createElement('div');
      window.className = 'chatkit-corner-window';
      const chatkit = document.createElement('openai-chatkit');
      window.appendChild(chatkit);
      document.body.appendChild(window);

      let isInitialized = false;
      button.addEventListener('click', () => {
        const isOpen = window.classList.toggle('open');
        button.innerHTML = isOpen ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>';

        // Apply icon color after changing icon
        const svg = button.querySelector('svg');
        if (svg) {
          const iconColor = document.getElementById('icon-color')?.value || '#ffffff';
          svg.style.stroke = iconColor;
        }

        if (isOpen && !isInitialized) {
          chatkit.setOptions({
            ...config,
            api: { getClientSecret }
          });
          isInitialized = true;
        }
      });
    }

    customElements.whenDefined('openai-chatkit').then(initCornerWidget);
  })();
  </script>

  <!-- Embed Widget -->
  <script>
  (function() {
    // Fetch base URL from server
    let CHATKIT_SERVER_URL = window.location.origin;

    async function initEmbedWidget() {
      try {
        const urlResponse = await fetch('/api/base-url');
        const urlData = await urlResponse.json();
        CHATKIT_SERVER_URL = urlData.baseUrl;
      } catch (error) {
        console.error('Failed to fetch base URL:', error);
      }

      // Get or create user ID
      let userId = localStorage.getItem('chatkit_user_id_embed');
      if (!userId) {
        userId = `user_${Date.now()}_${Math.random().toString(36).substring(7)}`;
        localStorage.setItem('chatkit_user_id_embed', userId);
      }

      // Get client secret
      async function getClientSecret() {
        const response = await fetch(`${CHATKIT_SERVER_URL}/api/chatkit/session`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId })
        });
        const data = await response.json();
        return data.client_secret;
      }

      // Fetch config
      const configResponse = await fetch(`${CHATKIT_SERVER_URL}/api/chatkit/config`);
      const config = await configResponse.json();

      // Create embed widget
      const container = document.getElementById('chatkit-embed');
      const chatkit = document.createElement('openai-chatkit');
      container.appendChild(chatkit);

      chatkit.setOptions({
        ...config,
        api: { getClientSecret }
      });
    }

    customElements.whenDefined('openai-chatkit').then(initEmbedWidget);
  })();
  </script>
</body>
</html>
